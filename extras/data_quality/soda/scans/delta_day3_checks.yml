# Soda Scan: Day 3 Delta Validation
#
# Validates that demo_apply_delta --args '{day: 3}' applied changes correctly.
#
# Expected changes from Day 2:
# - jaffle_shop.customers: no change (still 6)
# - jaffle_shop.products: no change (still 5)
# - jaffle_shop.orders: +3 rows (IDs 12-14)
# - jaffle_shop.order_items: +6 rows (IDs 23-28)
# - jaffle_shop.payments: +3 rows (IDs 7-9)
# - jaffle_crm.email_activity: +3 rows (IDs 17-19)
# - jaffle_crm.web_sessions: +3 rows (IDs 17-19)
#
# Usage:
#   # After running: dbt run-operation demo_apply_delta --args '{day: 3}'
#   soda scan -d demo_source -c configuration.yml delta_day3_checks.yml

checks for jaffle_shop.customers:
  - row_count = 6  # unchanged from Day 2

checks for jaffle_shop.products:
  - row_count = 5  # unchanged
  # Verify product ID 3 still has updated price from Day 2
  - failed rows:
      fail query: |
        SELECT product_id
        FROM jaffle_shop.products
        WHERE product_id = 3 AND price != 9.99
      name: Product ID 3 maintains updated price of $9.99

checks for jaffle_shop.orders:
  - row_count = 14  # Day 2 (11) + 3 new
  - missing_count(order_id) = 0
  - duplicate_count(order_id) = 0
  # Verify new orders exist (IDs 12-14)
  - failed rows:
      fail query: |
        SELECT expected_id
        FROM (VALUES (12), (13), (14)) AS expected(expected_id)
        WHERE NOT EXISTS (
          SELECT 1 FROM jaffle_shop.orders WHERE order_id = expected_id
        )
      name: Order IDs 12-14 exist
  # Referential integrity still valid
  - values in (customer_id) must exist in jaffle_shop.customers (customer_id)

checks for jaffle_shop.order_items:
  - row_count = 28  # Day 2 (22) + 6 new
  - missing_count(order_item_id) = 0
  - duplicate_count(order_item_id) = 0
  # Verify new order items exist (IDs 23-28)
  - failed rows:
      fail query: |
        SELECT expected_id
        FROM (VALUES (23), (24), (25), (26), (27), (28)) AS expected(expected_id)
        WHERE NOT EXISTS (
          SELECT 1 FROM jaffle_shop.order_items WHERE order_item_id = expected_id
        )
      name: Order item IDs 23-28 exist
  # Referential integrity
  - values in (order_id) must exist in jaffle_shop.orders (order_id)
  - values in (product_id) must exist in jaffle_shop.products (product_id)

checks for jaffle_shop.payments:
  - row_count = 9  # Day 2 (6) + 3 new
  - missing_count(payment_id) = 0
  - duplicate_count(payment_id) = 0
  # Verify new payments exist (IDs 7-9)
  - failed rows:
      fail query: |
        SELECT expected_id
        FROM (VALUES (7), (8), (9)) AS expected(expected_id)
        WHERE NOT EXISTS (
          SELECT 1 FROM jaffle_shop.payments WHERE payment_id = expected_id
        )
      name: Payment IDs 7-9 exist
  # Referential integrity
  - values in (order_id) must exist in jaffle_shop.orders (order_id)

checks for jaffle_crm.campaigns:
  - row_count = 3  # unchanged

checks for jaffle_crm.email_activity:
  - row_count = 19  # Day 2 (16) + 3 new
  - missing_count(activity_id) = 0
  - duplicate_count(activity_id) = 0
  # Verify new email activities exist (IDs 17-19)
  - failed rows:
      fail query: |
        SELECT expected_id
        FROM (VALUES (17), (18), (19)) AS expected(expected_id)
        WHERE NOT EXISTS (
          SELECT 1 FROM jaffle_crm.email_activity WHERE activity_id = expected_id
        )
      name: Email activity IDs 17-19 exist
  # Referential integrity
  - values in (campaign_id) must exist in jaffle_crm.campaigns (campaign_id)

checks for jaffle_crm.web_sessions:
  - row_count = 19  # Day 2 (16) + 3 new
  - missing_count(session_id) = 0
  - duplicate_count(session_id) = 0
  # Verify new web sessions exist (IDs 17-19)
  - failed rows:
      fail query: |
        SELECT expected_id
        FROM (VALUES (17), (18), (19)) AS expected(expected_id)
        WHERE NOT EXISTS (
          SELECT 1 FROM jaffle_crm.web_sessions WHERE session_id = expected_id
        )
      name: Web session IDs 17-19 exist
