# Soda Core Data Contracts for jaffle_crm Database
#
# This file defines data quality checks for the jaffle_crm marketing database.
# Run these checks after loading baseline or applying deltas to verify data integrity.
#
# Usage:
#   # DuckDB/MotherDuck:
#   soda scan -d demo_source -c extras/soda/configuration.yml extras/soda/contracts/jaffle_crm.yml
#
#   # Azure SQL (update configuration.yml to use database: jaffle_crm, schema: crm):
#   soda scan -d demo_source -c extras/soda/configuration.yml extras/soda/contracts/jaffle_crm.yml
#
# Expected row counts:
#   Baseline (Day 0): campaigns=5, email_activity=2500, web_sessions=1000
#   Day 1: campaigns=5, email_activity=2575, web_sessions=1037
#   Day 2: campaigns=5, email_activity=2641, web_sessions=1073
#   Day 3: campaigns=5, email_activity=2717, web_sessions=1112

# ============================================================================
# Table: campaigns
# ============================================================================
# Marketing campaign master data

checks for jaffle_crm.campaigns:
  # Row count validation (baseline minimum - new campaigns could be added)
  - row_count >= 5:
      name: Campaign catalog has at least 5 campaigns

  # Duplicate detection
  - duplicate_count(campaign_id) = 0:
      name: Campaigns have unique IDs

  # Null validation
  - missing_count(campaign_id) = 0
  - missing_count(campaign_name) = 0
  - missing_count(start_date) = 0

  # Budget validation
  - failed rows:
      fail condition: budget < 0
      name: All campaign budgets are non-negative

  # Business rule: End date should be after start date (when present)
  - failed rows:
      fail query: |
        SELECT campaign_id, start_date, end_date
        FROM jaffle_crm.campaigns
        WHERE end_date IS NOT NULL AND end_date < start_date
      name: Campaign end_date is after start_date when present

# ============================================================================
# Table: email_activity
# ============================================================================
# Email engagement tracking (sent, opened, clicked)

checks for jaffle_crm.email_activity:
  # Row count validation (baseline minimum)
  - row_count >= 100

  # Duplicate detection
  - duplicate_count(activity_id) = 0:
      name: Email activities have unique IDs

  # Null validation
  - missing_count(activity_id) = 0
  - missing_count(customer_id) = 0
  - missing_count(campaign_id) = 0
  - missing_count(sent_date) = 0
  - missing_count(opened) = 0
  - missing_count(clicked) = 0

  # Foreign key integrity: All email activities reference valid customers
  # Note: Uses jaffle_shop.customers - adjust for your database setup
  - failed rows:
      fail query: |
        SELECT ea.activity_id, ea.customer_id
        FROM jaffle_crm.email_activity ea
        WHERE NOT EXISTS (
          SELECT 1 FROM jaffle_shop.customers c
          WHERE c.customer_id = ea.customer_id
        )
      name: All email activities have valid customer_id foreign keys

  # Foreign key integrity: All email activities reference valid campaigns
  - failed rows:
      fail query: |
        SELECT ea.activity_id, ea.campaign_id
        FROM jaffle_crm.email_activity ea
        LEFT JOIN jaffle_crm.campaigns c ON ea.campaign_id = c.campaign_id
        WHERE c.campaign_id IS NULL
      name: All email activities have valid campaign_id foreign keys

  # Business rule: if clicked, must be opened
  - failed rows:
      fail condition: clicked = TRUE AND opened = FALSE
      name: Emails that were clicked must have been opened

  # SLA/Freshness check: Email activities should be recent (within 60 days)
  - freshness(sent_date) < 60d:
      name: Email activities are within expected time window

# ============================================================================
# Table: web_sessions
# ============================================================================
# Website visitor session tracking

checks for jaffle_crm.web_sessions:
  # Row count validation (baseline minimum)
  - row_count >= 150

  # Duplicate detection
  - duplicate_count(session_id) = 0:
      name: Web sessions have unique IDs

  # Null validation
  - missing_count(session_id) = 0
  - missing_count(session_start) = 0
  - missing_count(page_views) = 0

  # Foreign key integrity: Customer ID is optional (anonymous sessions allowed)
  # But when present, must reference valid customer
  - failed rows:
      fail query: |
        SELECT ws.session_id, ws.customer_id
        FROM jaffle_crm.web_sessions ws
        WHERE ws.customer_id IS NOT NULL
          AND NOT EXISTS (
            SELECT 1 FROM jaffle_shop.customers c
            WHERE c.customer_id = ws.customer_id
          )
      name: All web sessions with customer_id have valid foreign keys

  # Business rule: Session end should be after session start (when present)
  - failed rows:
      fail query: |
        SELECT session_id, session_start, session_end
        FROM jaffle_crm.web_sessions
        WHERE session_end IS NOT NULL AND session_end < session_start
      name: session_end is after session_start when present

  # Business rule: Page views should be non-negative
  - failed rows:
      fail condition: page_views < 0
      name: page_views is non-negative

  # SLA/Freshness check: Web sessions should be recent (within 60 days)
  - freshness(session_start) < 60d:
      name: Web sessions are within expected time window
