dataContractSpecification: 0.9.2
id: jaffle_shop_order_items
info:
  title: Jaffle Shop Order Items
  version: 1.0.0
  description: |
    Order line items from the jaffle_shop ERP system, linking products to orders.

    **Deterministic Evolution:**
    - Baseline state: 10 order items (IDs 1-10) across 5 orders
    - Day 1 delta: +6 order items (IDs 11-16) for new orders 6-8
    - Day 2 delta: +6 order items (IDs 17-22) for new orders 9-11
    - Day 3 delta: +6 order items (IDs 23-28) for new orders 12-14

    **Patterns:**
    - Append-only event stream (new items only)
    - No updates or soft deletes
    - Foreign keys to orders and products tables
    - Quantity and unit_price captured at order time
  owner: ERP System Team
  contact:
    name: Data Platform Team
    email: data-platform@example.com

servers:
  duckdb:
    type: duckdb
    location: data/demo_source.duckdb
    schema: jaffle_shop
    table: order_items
  databricks:
    type: databricks
    host: ${DATABRICKS_SERVER_HOSTNAME}
    catalog: ${DATABRICKS_CATALOG}
    schema: erp
    table: order_items

models:
  order_items:
    description: Order line items linking products to orders
    type: table
    fields:
      order_item_id:
        type: integer
        required: true
        unique: true
        primary: true
        description: Unique order item identifier

      order_id:
        type: integer
        required: true
        description: Foreign key to orders table
        references: orders.order_id

      product_id:
        type: integer
        required: true
        description: Foreign key to products table
        references: products.product_id

      quantity:
        type: integer
        required: true
        description: Quantity of product ordered
        minValue: 1
        example: 2

      unit_price:
        type: decimal
        required: true
        description: Price per unit at time of order (historical price snapshot)
        precision: 10
        scale: 2
        minValue: 0.00
        example: "3.99"

      created_at:
        type: timestamp
        required: true
        description: Record creation timestamp (when line item was added)

      updated_at:
        type: timestamp
        required: true
        description: Record last update timestamp (rarely changes for append-only)

      deleted_at:
        type: timestamp
        required: false
        description: Soft delete timestamp (rarely used for immutable line items)

quality:
  type: SodaCL
  specification: |
    checks for order_items:
      # Baseline state: exactly 10 order items
      - row_count = 10

      # Primary key validation
      - missing_count(order_item_id) = 0
      - duplicate_count(order_item_id) = 0

      # Known order item IDs at baseline
      - values in (order_item_id) must be in [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]

      # Required fields
      - missing_count(order_id) = 0
      - missing_count(product_id) = 0
      - missing_count(quantity) = 0
      - missing_count(unit_price) = 0
      - missing_count(created_at) = 0
      - missing_count(updated_at) = 0

      # Referential integrity (at baseline)
      - values in (order_id) must be in [1, 2, 3, 4, 5]
      - values in (product_id) must be in [1, 2, 3, 4, 5]

      # Business rule validation
      - min(quantity) >= 1
      - min(unit_price) >= 0.00

      # No soft deletes in baseline (append-only)
      - missing_count(deleted_at) = 10

      # Validate that unit_price matches historical product prices
      - schema:
          fail:
            when wrong column type:
              unit_price: decimal

examples:
  - type: csv
    model: order_items
    data: |
      order_item_id,order_id,product_id,quantity,unit_price,created_at,updated_at,deleted_at
      1,1,1,2,3.99,2024-01-15 09:00:00,2024-01-15 09:00:00,
      2,1,3,1,8.99,2024-01-15 09:00:00,2024-01-15 09:00:00,
      3,2,2,3,2.50,2024-01-15 10:15:00,2024-01-15 10:15:00,
      4,2,5,1,4.50,2024-01-15 10:15:00,2024-01-15 10:15:00,
      5,3,4,1,7.99,2024-01-15 11:30:00,2024-01-15 11:30:00,
      6,3,1,2,3.99,2024-01-15 11:30:00,2024-01-15 11:30:00,
      7,4,3,2,8.99,2024-01-15 13:45:00,2024-01-15 13:45:00,
      8,5,2,1,2.50,2024-01-15 14:00:00,2024-01-15 14:00:00,
      9,5,5,2,4.50,2024-01-15 14:00:00,2024-01-15 14:00:00,
      10,5,1,1,3.99,2024-01-15 14:00:00,2024-01-15 14:00:00,

tags:
  - source-system
  - erp
  - jaffle-shop
  - order-items
  - deterministic
  - append-only
